<!--
  Name: process_gps_imu.launch
  Triggers:
    * rosbag playback
    * imu_covariance
    * kr_attitude_eskf
    * pressure_altimeter
    * gps_odom
    * gps_kf
    * iris_tf

  Brief: Launch the GPS + IMU components of the post-processing suite.
-->
<launch>
    <!-- Profile -->
    <arg name="platform" default="steadicam"/>
    <arg name="version" default="v4"/>
    <arg name="profile" default="$(arg platform)/$(arg version)"/>
    <arg name="profile_path" default="$(find galt_setup)/profiles/$(arg profile)"/>

    <!-- Bag -->
    <arg name="bag_home" default="$(env GALT_BAGFILES)"/>
    <arg name="bag" default=""/>
    <arg name="bag_start" default="0"/>
    <arg name="bag_rate" default="1"/>
    <!-- <arg name="bag_path" default="$(arg bag_home)/$(arg bag).bag"/> -->
    <arg name="bag_path" default="/home/chao/Workspace/bag/biglerville/steadicam/fruit_3_2014-10-24-13-10-13.bag"/>

    <!-- Rosbag -->
    <node name="playback" pkg="rosbag" type="play" output="log"
        args="--clock -s $(arg bag_start) -r $(arg bag_rate)
        $(arg bag_path)">
    </node>

    <!-- Frame broadcaster -->
    <include file="$(arg profile_path)/tf.launch">
    </include>

    <!-- Laser pipeline -->
    <include file="$(find galt_setup)/launch/process/laser/laser_pipeline.launch">
        <arg name="plugin" value="$(arg profile_path)/laser_filter.yml"/>
    </include>

    <!-- Magnetometer calibration to load -->
    <arg name="mag_calib" default="biglerville_oct_ground"/>

    <!-- IMU Covariance -->
    <include file="$(find galt_setup)/launch/process/imu/imu_covariance.launch">
        <arg name="config" value="$(arg profile_path)/imu.yml"/>
    </include>    

    <!-- Attitude Filter -->
    <node pkg="kr_attitude_eskf" name="attitude_eskf" type="kr_attitude_eskf"
        output="screen">
        <param name="enable_magnetometer" type="bool" value="true"/>

        <!-- Magnetometer calibration parameters -->
        <rosparam
            file="$(find galt_setup)/calib/magnetometer/$(arg mag_calib).yml"/>

        <!-- IMU data w/ proper covariance parameters -->
        <remap from="~imu" to="/imu/imu_covariance/imu"/>
        <remap from="~magnetic_field" to="/imu/imu_covariance/magnetic_field"/>
    </node>

    <!-- Barometric altimeter -->
    <node name="pressure_altimeter" pkg="pressure_altimeter"
        type="pressure_altimeter" output="screen">
        <!-- name of the frame in the header of the output -->
        <param name="world_frame_id" type="string" value="world"/>
        <!-- input topic -->
        <remap from="~fluid_pressure" to="/imu/imu_covariance/pressure"/>
    </node>

    <!-- Laser altimeter -->
    <node name="laser_altimeter" pkg="laser_altimeter"
        type="laser_altimeter" output="screen">
        <remap from="~imu" to="/attitude_eskf/filtered_imu"/>
        <remap from="~laser_scan" to="/laser/scan_filtered"/>
    </node>

    <!-- GPS odometer -->
    <include file="$(find galt_setup)/launch/process/gps/gps_odom.launch">
        <arg name="config" value="$(arg profile_path)/gps_odom.yml"/>
    </include>

    <!-- GPS KF -->
    <node name="gps_kf" pkg="gps_kf" type="gps_kf" output="screen">
        <!-- filter inputs -->
        <remap from="~imu" to="/attitude_eskf/filtered_imu"/>
        <remap from="~gps_odom" to="/gps/gps_odom/odometry"/>

        <!-- Profile specific settings -->
        <rosparam
            file="$(find galt_setup)/profiles/$(arg profile)/gps_kf.yml"/>
    </node>
</launch>
