<!--
  Name: process_gps_imu.launch
  Triggers:
    * rosbag playback
    * imu_covariance
    * kr_attitude_eskf
    * pressure_altimeter
    * gps_odom
    * gps_kf
    * iris_tf

  Brief: Launch the GPS + IMU components of the post-processing suite.
-->
<launch>
    <!-- Profile -->
    <arg name="platform" default="steadicam"/>
    <arg name="version" default="v4"/>
    <arg name="profile" default="$(arg platform)/$(arg version)"/>
    <arg name="profile_path" default="$(find galt_setup)/profiles/$(arg profile)"/>
    <arg name="vicon" default="false"/>

    <!-- Bag -->
    <arg name="bag_home" default="$(env GALT_BAGFILES)"/>
    <arg name="bag"/>
    <arg name="bag_start" default="0"/>
    <arg name="bag_rate" default="1"/>
    <arg name="bag_path" default="$(arg bag_home)/$(arg bag).bag"/>

    <!-- Rosbag -->
    <node name="playback" pkg="rosbag" type="play" output="log"
        args="--clock -s $(arg bag_start) -r $(arg bag_rate)
        $(arg bag_path)">
    </node>

    <!-- Frame broadcaster -->
    <include file="$(arg profile_path)/tf.launch">
      <arg name="vicon" value="$(arg vicon)"/>
    </include>

    <!-- Laser pipeline -->
    <include file="$(find galt_setup)/launch/process/laser/laser_pipeline.launch">
        <arg name="plugin" value="$(arg profile_path)/laser_filter.yml"/>
    </include>

    <!-- Magnetometer calibration to load -->
    <arg name="mag_calib"/>

    <!-- IMU covariance -->
    <include file="$(find galt_setup)/launch/process/imu/imu_covariance.launch">
        <arg name="config" value="$(arg profile_path)/imu.yml"/>
    </include>

    <!-- Altimeter -->
    <include file="$(find galt_setup)/launch/process/filter/laser_altimeter.launch">
        <arg name="imu" value="/attitude_eskf/filtered_imu"/>
    </include>

    <include file="$(find galt_setup)/launch/process/filter/pressure_altimeter.launch">
        <arg name="pressure" value="/imu/imu_covariance/pressure"/>
    </include>

    <!-- GPS odometer -->
    <include file="$(find galt_setup)/launch/process/gps/gps_odom.launch">
        <arg name="config" value="$(arg profile_path)/gps_odom.yml"/>
    </include>

    <!-- Attitude Filter -->
    <node pkg="kr_attitude_eskf" name="attitude_eskf" type="kr_attitude_eskf"
        output="screen">
        <param name="enable_magnetometer" type="bool" value="true"/>

        <!-- Magnetometer calibration parameters -->
        <rosparam
            file="$(find galt_setup)/calib/magnetometer/$(arg mag_calib).yml"/>

        <!-- IMU data w/ proper covariance parameters -->
        <remap from="~imu" to="/imu/imu_covariance/imu"/>
        <remap from="~magnetic_field" to="/imu/imu_covariance/magnetic_field"/>
    </node>

    <!-- GPS KF -->
    <node name="gps_kf" pkg="gps_kf" type="gps_kf" output="screen">
        <!-- filter inputs -->
        <remap from="~imu" to="/attitude_eskf/filtered_imu"/>
        <remap from="~gps_odom" to="/gps/odometry"/>

        <!-- Profile specific settings -->
        <rosparam
            file="$(find galt_setup)/profiles/$(arg profile)/gps_kf.yml"/>
    </node>
</launch>
